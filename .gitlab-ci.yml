variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2
  GIT_SUBMODULE_STRATEGY: normal
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

image:
  name: docker/compose
  entrypoint: ["/bin/sh", "-c"]

services:
  - docker:dind

cache:
  key: ${CI_JOB_NAME}
  paths:
    - .cache/pip

stages:
  - check
  - build
  - tag
  - package
  - publish

Version Check:
  stage: check
  image: python:3.12
  only:
    - branches
  except:
    - master
  before_script:
    - pip install poetry
    - poetry check
  script:
    - git fetch --tags
    - sed -i -e 's/\r$//' scripts/check_version_update.sh
    - scripts/check_version_update.sh

build-windows:
  stage: build
  except:
    - master
  script:
    - docker image prune -f
    - docker-compose -f docker-compose.build.yml build --no-cache
    - docker-compose -f docker-compose.build.yml up --exit-code-from app-windows
  after_script:
    - docker-compose -f docker-compose.build.yml down
    - ls -la .
  artifacts:
    paths:
      - ${CI_PROJECT_DIR}/dist/windows
    expire_in: 1 week

package-windows:
  stage: package
  only:
    - tags
  dependencies:
    - build-windows
  before_script:
    - ls ./dist/windows/
  script:
    - docker image prune -f
    - docker-compose -f docker-compose.dist.yml build --no-cache
    - docker-compose -f docker-compose.dist.yml up --exit-code-from dist-windows
    - ls -la ./dist/windows
  after_script:
    - docker-compose -f docker-compose.dist.yml down
    - pwd
    - echo ${CI_PROJECT_DIR}
    - ls -la ${CI_PROJECT_DIR}/dist/windows
  artifacts:
    paths:
      - ${CI_PROJECT_DIR}/dist/windows
    expire_in: 1 week

Tag Release:
  stage: tag
  image: python:3.12
  only:
    - master
  before_script:
    - pip install poetry
    - poetry config virtualenvs.create false
  script:
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - project_url=$(echo $CI_PROJECT_URL | sed 's/https:\/\///')
    - git remote add api-origin https://oauth2:${GITLAB_ACCESS_TOKEN}@${project_url} || echo "remote already set"
    - version=$(poetry version --short)
    - git tag $version
    - git push api-origin $version

publish:
  stage: publish
  only:
    - tags
  image: inetprocess/gitlab-release
  dependencies:
    - package-windows
  before_script:
    - apk update
    - apk add perl
    - VERSION_NUMBER=$(perl -nle'print $& while m{(?<=^version = ")(.*)(?=")}g' pyproject.toml)
    - echo ${CI_COMMIT_TAG}
  script:
    - ls -la ./dist/windows/
    - mv ./dist/windows/Mixcloud\ Bulk\ Downloader.zip ./dist/windows/Mixcloud\ Bulk\ Downloader\ ${VERSION_NUMBER}.zip
    - ls -la ./dist/windows/
    - gitlab-release --message 'Automatic release' ./dist/windows/Mixcloud\ Bulk\ Downloader\ ${VERSION_NUMBER}.zip
